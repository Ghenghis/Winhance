<UserControl x:Class="Winhance.WPF.Features.FileManager.Views.BatchRenameView"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:viewModels="clr-namespace:Winhance.WPF.Features.FileManager.ViewModels"
  xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks" d:DataContext="{d:DesignInstance Type=viewModels:BatchRenameViewModel}" mc:Ignorable="d">

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!-- File Selection Section -->
    <Border Grid.Row="0" Background="{DynamicResource CardBackground}" CornerRadius="8" Padding="15" Margin="0,0,0,10">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Horizontal">
          <TextBlock Text="Source:" FontSize="14" FontWeight="SemiBold" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryTextColor}" Width="60" />
          <TextBox Text="{Binding SourcePath, Mode=TwoWay}" Width="400" Height="32" VerticalContentAlignment="Center" Background="{DynamicResource MainContainerBorderBrush}" Foreground="{DynamicResource PrimaryTextColor}" />
          <Button Content="Browse..." Width="80" Height="32" Margin="10,0,0,0" Style="{DynamicResource SecondaryButtonStyle}" />
          <Button Content="Add Files..." Width="90" Height="32" Margin="10,0,0,0" Style="{DynamicResource SecondaryButtonStyle}" />
        </StackPanel>

        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,10,0,0">
          <TextBlock Text="Filter:" FontSize="14" VerticalAlignment="Center" Foreground="{DynamicResource SubTextColor}" Width="60" />
          <TextBox Text="{Binding FilterPattern, Mode=TwoWay}" Width="150" Height="28" VerticalContentAlignment="Center" Background="{DynamicResource MainContainerBorderBrush}" Foreground="{DynamicResource PrimaryTextColor}" />
          <CheckBox Content="Include subfolders" IsChecked="{Binding IncludeSubfolders}" Margin="20,0,0,0" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryTextColor}" />
          <TextBlock Text="{Binding TotalFiles, StringFormat='{}{0} files selected'}" FontSize="14" Margin="30,0,0,0" VerticalAlignment="Center" Foreground="{DynamicResource AccentColor}" />
        </StackPanel>
      </Grid>
    </Border>

    <!-- Rename Rules Section -->
    <Border Grid.Row="1" Background="{DynamicResource CardBackground}" CornerRadius="8" Padding="15" Margin="0,0,0,10" MaxHeight="200">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="RENAME RULES" FontSize="12" FontWeight="Bold" Foreground="{DynamicResource SubTextColor}" Margin="0,0,0,10" />

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
          <ItemsControl ItemsSource="{Binding Rules}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Background="{DynamicResource MainContainerBorderBrush}" CornerRadius="5" Padding="10" Margin="0,0,0,5">
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto" />
                      <ColumnDefinition Width="Auto" />
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Order Buttons -->
                    <StackPanel Grid.Column="0" Orientation="Vertical" Margin="0,0,10,0">
                      <Button Width="20" Height="20" Command="{Binding DataContext.MoveRuleUpCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}" Style="{DynamicResource SmallIconButtonStyle}">
                        <iconPacks:PackIconMaterial Kind="ChevronUp" Width="12" Height="12" />
                      </Button>
                      <Button Width="20" Height="20" Command="{Binding DataContext.MoveRuleDownCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}" Style="{DynamicResource SmallIconButtonStyle}">
                        <iconPacks:PackIconMaterial Kind="ChevronDown" Width="12" Height="12" />
                      </Button>
                    </StackPanel>

                    <!-- Rule Type -->
                    <TextBlock Grid.Column="1" Text="{Binding RuleTypeDisplay}" FontWeight="SemiBold" Width="120" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryTextColor}" />

                    <!-- Rule Parameters -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                      <TextBox Text="{Binding FindText}" Width="150" Height="28" Margin="0,0,5,0" Visibility="{Binding RuleType, Converter={StaticResource RuleTypeToVisibilityConverter}, ConverterParameter=FindReplace}" Background="{DynamicResource CardBackground}" Foreground="{DynamicResource PrimaryTextColor}" />
                      <TextBlock Text="→" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{DynamicResource SubTextColor}" />
                      <TextBox Text="{Binding ReplaceText}" Width="150" Height="28" Background="{DynamicResource CardBackground}" Foreground="{DynamicResource PrimaryTextColor}" />
                    </StackPanel>

                    <!-- Remove Button -->
                    <Button Grid.Column="3" Width="24" Height="24" Command="{Binding DataContext.RemoveRuleCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}" Style="{DynamicResource SmallIconButtonStyle}">
                      <iconPacks:PackIconMaterial Kind="Close" Width="12" Height="12" />
                    </Button>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>

        <!-- Add Rule Buttons -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,10,0,0">
          <Button Content="+ Find/Replace" Height="28" Margin="0,0,5,0" Command="{Binding AddRuleCommand}" CommandParameter="FindReplace" Style="{DynamicResource SecondaryButtonStyle}" />
          <Button Content="+ Counter" Height="28" Margin="0,0,5,0" Command="{Binding AddRuleCommand}" CommandParameter="Counter" Style="{DynamicResource SecondaryButtonStyle}" />
          <Button Content="+ Case" Height="28" Margin="0,0,5,0" Command="{Binding AddRuleCommand}" CommandParameter="ChangeCase" Style="{DynamicResource SecondaryButtonStyle}" />
          <Button Content="+ Extension" Height="28" Margin="0,0,5,0" Command="{Binding AddRuleCommand}" CommandParameter="ChangeExtension" Style="{DynamicResource SecondaryButtonStyle}" />
          <Border Width="1" Height="20" Background="#404040" Margin="10,0" />
          <ComboBox ItemsSource="{Binding Presets}" SelectedItem="{Binding SelectedPreset}" DisplayMemberPath="Name" Width="150" Height="28" />
          <Button Content="Load Preset" Height="28" Margin="5,0,0,0" Command="{Binding LoadPresetCommand}" CommandParameter="{Binding SelectedPreset}" Style="{DynamicResource SecondaryButtonStyle}" />
          <Button Content="Clear All" Height="28" Margin="10,0,0,0" Command="{Binding ClearAllRulesCommand}" Style="{DynamicResource DangerButtonStyle}" />
        </StackPanel>
      </Grid>
    </Border>

    <!-- Preview Section -->
    <Border Grid.Row="2" Background="{DynamicResource CardBackground}" CornerRadius="8" Padding="15">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
          <TextBlock Text="LIVE PREVIEW" FontSize="12" FontWeight="Bold" Foreground="{DynamicResource SubTextColor}" />
          <TextBlock Text="{Binding ConflictCount, StringFormat='  ({0} conflicts)'}" FontSize="12" Foreground="#FF6B6B" Visibility="{Binding ConflictCount, Converter={StaticResource IntToVisibilityConverter}}" />
        </StackPanel>

        <ListView Grid.Row="1" ItemsSource="{Binding PreviewItems}" Background="Transparent" BorderThickness="0" VirtualizingPanel.IsVirtualizing="True">
          <ListView.View>
            <GridView>
              <GridViewColumn Header="#" Width="40" DisplayMemberBinding="{Binding}" />
              <GridViewColumn Header="Original Name" Width="250" DisplayMemberBinding="{Binding OriginalName}" />
              <GridViewColumn Header="" Width="30">
                <GridViewColumn.CellTemplate>
                  <DataTemplate>
                    <TextBlock Text="→" Foreground="{DynamicResource SubTextColor}" />
                  </DataTemplate>
                </GridViewColumn.CellTemplate>
              </GridViewColumn>
              <GridViewColumn Header="New Name" Width="250" DisplayMemberBinding="{Binding NewName}" />
              <GridViewColumn Header="Status" Width="60">
                <GridViewColumn.CellTemplate>
                  <DataTemplate>
                    <iconPacks:PackIconMaterial Kind="{Binding StatusIcon}" Width="16" Height="16" Foreground="{Binding StatusColor}" />
                  </DataTemplate>
                </GridViewColumn.CellTemplate>
              </GridViewColumn>
            </GridView>
          </ListView.View>
        </ListView>
      </Grid>
    </Border>

    <!-- Action Buttons -->
    <Border Grid.Row="3" Background="{DynamicResource MainContainerBorderBrush}" CornerRadius="8" Padding="15" Margin="0,10,0,0">
      <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
        <Button Content="Preview Refresh" Width="120" Height="35" Margin="0,0,10,0" Command="{Binding RefreshPreviewCommand}" Style="{DynamicResource SecondaryButtonStyle}" />
        <Button Content="Apply Rename" Width="120" Height="35" Margin="0,0,10,0" Command="{Binding ApplyRenameCommand}" Style="{DynamicResource PrimaryButtonStyle}" />
        <Button Content="Undo Last Batch" Width="120" Height="35" Command="{Binding UndoLastBatchCommand}" IsEnabled="{Binding CanUndo}" Style="{DynamicResource SecondaryButtonStyle}" />
      </StackPanel>
    </Border>
  </Grid>
</UserControl>
